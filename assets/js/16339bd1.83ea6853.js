"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[19912],{15680:(e,a,t)=>{t.d(a,{xA:()=>c,yg:()=>g});var n=t(96540);function i(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){i(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,i=function(e,a){if(null==e)return{};var t,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||(i[t]=e[t]);return i}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=n.createContext({}),p=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},c=function(e){var a=p(e.components);return n.createElement(s.Provider,{value:a},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),h=p(t),u=i,g=h["".concat(s,".").concat(u)]||h[u]||d[u]||r;return t?n.createElement(g,l(l({ref:a},c),{},{components:t})):n.createElement(g,l({ref:a},c))}));function g(e,a){var t=arguments,i=a&&a.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=u;var o={};for(var s in a)hasOwnProperty.call(a,s)&&(o[s]=a[s]);o.originalType=e,o[h]="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=t[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},97570:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>f,contentTitle:()=>y,default:()=>v,frontMatter:()=>g,metadata:()=>m,toc:()=>b});var n=t(15680),i=Object.defineProperty,r=Object.defineProperties,l=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,c=(e,a,t)=>a in e?i(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,h=(e,a)=>{for(var t in a||(a={}))s.call(a,t)&&c(e,t,a[t]);if(o)for(var t of o(a))p.call(a,t)&&c(e,t,a[t]);return e},d=(e,a)=>r(e,l(a)),u=(e,a)=>{var t={};for(var n in e)s.call(e,n)&&a.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&o)for(var n of o(e))a.indexOf(n)<0&&p.call(e,n)&&(t[n]=e[n]);return t};const g={},y="Write a Package",m={unversionedId:"write-a-package",id:"version-v4.20/write-a-package",title:"Write a Package",description:"This tutorial walks you through the creation of a package, which",source:"@site/versioned_docs/version-v4.20/write-a-package.md",sourceDirName:".",slug:"/write-a-package",permalink:"/v4.20/write-a-package",draft:!1,editUrl:"https://github.com/tenzir/tenzir/tree/main/web/versioned_docs/version-v4.20/write-a-package.md",tags:[],version:"v4.20",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Map Data to OCSF",permalink:"/v4.20/map-data-to-ocsf/"},next:{title:"Installation",permalink:"/v4.20/installation"}},f={},b=[{value:"Map the use case",id:"map-the-use-case",level:2},{value:"Create the scaffold",id:"create-the-scaffold",level:2},{value:"Add your pipelines, context, and examples",id:"add-your-pipelines-context-and-examples",level:2},{value:"Add a context",id:"add-a-context",level:3},{value:"Keep the context synchronized",id:"keep-the-context-synchronized",level:3},{value:"Entice with examples",id:"entice-with-examples",level:3},{value:"Make the package configurable",id:"make-the-package-configurable",level:2},{value:"Test your package",id:"test-your-package",level:2},{value:"Share and contribute",id:"share-and-contribute",level:2}],w={toc:b},k="wrapper";function v(e){var a=e,{components:t}=a,i=u(a,["components"]);return(0,n.yg)(k,d(h(h({},w),i),{components:t,mdxType:"MDXLayout"}),(0,n.yg)("h1",h({},{id:"write-a-package"}),"Write a Package"),(0,n.yg)("p",null,"This tutorial walks you through the creation of a ",(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/packages"}),"package"),", which\nis a bundle of related pipelines and contexts. You can ",(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/installation/install-a-package"}),"install\npackages")," with a few clicks from the ",(0,n.yg)("a",h({parentName:"p"},{href:"https://app.tenzir.com/library"}),"Tenzir\nLibrary")," or deploy them as code."),(0,n.yg)("h2",h({},{id:"map-the-use-case"}),"Map the use case"),(0,n.yg)("p",null,"The goal of a package is to enable a specific use case. In this tutorial, we\nwant to make it easy to detect malicious certificates that are on the\n",(0,n.yg)("a",h({parentName:"p"},{href:"https://sslbl.abuse.ch/"}),"SSLBL")," from ",(0,n.yg)("a",h({parentName:"p"},{href:"https://abuse.ch"}),"abuse.ch"),". At a glance,\nthe idea is as follows:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"We get SHA1 hashes of SSL certifcates from network monitor logs, such as\n",(0,n.yg)("a",h({parentName:"li"},{href:"https://zeek.org"}),"Zeek")," or ",(0,n.yg)("a",h({parentName:"li"},{href:"https://suricata.io"}),"Suricata"),"."),(0,n.yg)("li",{parentName:"ol"},"We check each hash value against a lookup table."),(0,n.yg)("li",{parentName:"ol"},"We generate a detection finding when we encounter a match.")),(0,n.yg)("p",null,"Given this idea, we have to it to the building blocks we have in Tenzir:\n",(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/pipelines"}),"pipelines")," and ",(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/contexts"}),"contexts"),". We can model it as\nfollows."),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"A lookup table that includes a copy of the SSLBL data."),(0,n.yg)("li",{parentName:"ol"},"A pipeline that synchronizes the SSLBL data with the lookup table."),(0,n.yg)("li",{parentName:"ol"},"A pipeline to enrich network telemetry and generate detection findings.")),(0,n.yg)("h2",h({},{id:"create-the-scaffold"}),"Create the scaffold"),(0,n.yg)("p",null,"We begin with creating a ",(0,n.yg)("inlineCode",{parentName:"p"},"package.yaml")," file with the following metadata:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),"id: sslbl\nname: SSLBL\nauthor: Tenzir\nauthor_icon: https://github.com/tenzir.png\npackage_icon: |\n  https://raw.githubusercontent.com/tenzir/library/main/sslbl/package.svg\ndescription: |\n  The [SSLBL](https://sslbl.abuse.ch/) package makes available a lookup table\n  with SHA1 hashes of blacklisted certificates that can be used when monitoring\n  SSL/TLS certificate exchanges.\n")),(0,n.yg)("h2",h({},{id:"add-your-pipelines-context-and-examples"}),"Add your pipelines, context, and examples"),(0,n.yg)("p",null,"After providing the package metadata, we now do the heavy lift of writing pipelines, contexts, and examples."),(0,n.yg)("h3",h({},{id:"add-a-context"}),"Add a context"),(0,n.yg)("p",null,"First, we need a data structure to hold the SSLBL data so that we can use it\ninside the node. TO this end, we define a lookup table in the ",(0,n.yg)("inlineCode",{parentName:"p"},"contexts"),"\nsection:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),"contexts:\n  sslbl:\n    type: lookup-table\n    description: |\n      A table that is keyed by SHA1 hashes of SSL certificates on the SSL\n      blocklist.\n")),(0,n.yg)("p",null,"Let's figure out how to get data into the context manually. There's a CSV file\nat ",(0,n.yg)("a",h({parentName:"p"},{href:"https://sslbl.abuse.ch/blacklist/sslblacklist.csv"}),"https://sslbl.abuse.ch/blacklist/sslblacklist.csv"),". Let's take a look at\nthat in the browser:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-csv"}),"################################################################\n# abuse.ch SSLBL SSL Certificate Blacklist (SHA1 Fingerprints) #\n# Last updated: 2024-09-02 06:17:52 UTC                        #\n#                                                              #\n# Terms Of Use: https://sslbl.abuse.ch/blacklist/              #\n# For questions please contact sslbl [at] abuse.ch             #\n################################################################\n#\n# Listingdate,SHA1,Listingreason\n2024-09-02 06:17:52,4da14224452c1fe61f46b1112c43ecfd9f322c82,Rhadamanthys C&C\n2024-09-02 06:16:33,b331526a0949f88ce218555edf1060c4a02de5a2,Rhadamanthys C&C\n2024-09-02 05:19:10,b785d1a9e5784703b98a96698ad05dff5e07229a,DCRat C&C\n2024-09-02 05:18:33,be4d4f077bdd90618367eb2ab88f9f3074ccb7aa,AsyncRAT C&C\n2024-08-30 13:46:12,6bef207908bfad6b19580067ce770bc820d3d2ef,CobaltStrike C&C\n2024-08-29 09:02:20,9a57379949f734b11f32bb8462db1f3fd8898722,DarkGate C&C\n2024-08-29 09:01:39,47122f7861b7488f6711c999e40caaa5e560630b,Rhadamanthys C&C\n2024-08-29 09:01:33,fb0e13607d045047c29ab44941f450950a349dd7,Rhadamanthys C&C\n")),(0,n.yg)("p",null,"Okay, a simple CSV table with comments. We can write a pipeline for reading\nthat:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'// tql2\nload_http "from https://sslbl.abuse.ch/blacklist/sslblacklist.csv"\nread_csv comments=true, header="timestamp,SHA1,reason"\n')),(0,n.yg)("p",null,"Now that we have onboarded the data into a pipeline, we just need to push it\ninto the context by piping it to ",(0,n.yg)("inlineCode",{parentName:"p"},"context update"),":"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'// tql2\nload_http "from https://sslbl.abuse.ch/blacklist/sslblacklist.csv"\nread_csv comments=true, header="timestamp,SHA1,reason"\nlegacy "context update sslbl --key=SHA1"\n')),(0,n.yg)("p",null,"With ",(0,n.yg)("inlineCode",{parentName:"p"},"context inspect sslbl")," we can list the table contents, keyed by SHA1 hash\nand ready for enrichment."),(0,n.yg)("h3",h({},{id:"keep-the-context-synchronized"}),"Keep the context synchronized"),(0,n.yg)("p",null,"So far we did a one-shot download of the SSLBL data into our lookup table. But\nthe fine folks at abuse.ch update the data regularly, and we want to keep our\nlookup table in sync with the latest version."),(0,n.yg)("p",null,"To this end, we do the data onboarding periodically with ",(0,n.yg)("inlineCode",{parentName:"p"},"every"),":"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'// tql2\nevery 1h {\n  load_http "from https://sslbl.abuse.ch/blacklist/sslblacklist.csv"\n  read_csv comments=true, header="timestamp,SHA1,reason"\n}\nlegacy "context update sslbl --key=SHA1"\n')),(0,n.yg)("admonition",h({},{type:"tip"}),(0,n.yg)("mdxAdmonitionTitle",{parentName:"admonition"},"Why not wrap the entire pipeline in ",(0,n.yg)("inlineCode",{parentName:"mdxAdmonitionTitle"},"every"),"?"),(0,n.yg)("p",{parentName:"admonition"},"We could've also wrapped the entire pipeline in ",(0,n.yg)("inlineCode",{parentName:"p"},"every 1h {\u2026}")," with the same\neffect. However, if we split the data acquisition from the remaining work, we\nhave a more local change that turns a one-shot data download into a continuous\nstream. This has the effect that the other pipeline operators outside of ",(0,n.yg)("inlineCode",{parentName:"p"},"every"),"\nare running continuously, and more importantly, emit metrics continuously and\ncould also fail earlier, leading to an overall more robust pipeline\narchitecture.")),(0,n.yg)("p",null,"Now let's copy that into the package definition:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),'pipelines:\n  update-context:\n    name: Update SSLBL Context\n    description: |\n      A pipeline that periodically refreshes the SSLBL lookup table.\n    definition: |\n      // tql2\n      every 1h {\n        load_http "from https://sslbl.abuse.ch/blacklist/sslblacklist.csv"\n        read_csv comments=true, header="timestamp,SHA1,reason"\n      }\n      legacy "context update sslbl --key=SHA1"\n    restart-on-error: 1 hour\n')),(0,n.yg)("p",null,"From a developer's perspective, we now have a complete package consisting of a\ncontext and a pipeline that updates it. But from a user's perspective, what do\nwe do now? This is where the ",(0,n.yg)("inlineCode",{parentName:"p"},"examples")," section comes into play."),(0,n.yg)("h3",h({},{id:"entice-with-examples"}),"Entice with examples"),(0,n.yg)("p",null,"After you put thought into implementing the intricate dataflows and thoughtfully\nconfigured pipelines and context, it's time to switch from the developer to the\nuser persona. As a package developer, you want to make things reusable and easy!\nIn the ",(0,n.yg)("inlineCode",{parentName:"p"},"examples")," section you showcase how users can profit from the work that\nthe package does behind the scenes."),(0,n.yg)("p",null,'For our concrete scenario, we now want to use the SSLBL context that we set up\nand keep up to date. Our "work" was allowing users to just come with a SHA1 hash\ndigest, and the context quickly tells us good or bad.'),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),'examples:\n  - name: Enrich Suricata TLS logs with SSLBL domains\n    description: |\n      Enriches the certificate SHA1 fingerprint from Suricata TLS logs with the\n      SSLBL data.\n    definition: |\n      // tql2\n      subscribe "suricata"\n      where @name == "suricata.tls"\n      sha1 = tls.fingerprint.replace(":", "")\n      legacy "enrich sha1 sslbl"\n\n  - name: Display top-10 listing reasons\n    description: |\n      Shows a bar chart of the top-10 reasons why a certificate is in the\n      dataset.\n    definition: |\n      context inspect sslbl\n      | yield value\n      | top reason\n      | head\n      | chart bar\n')),(0,n.yg)("h2",h({},{id:"make-the-package-configurable"}),"Make the package configurable"),(0,n.yg)("p",null,"After we have illustrated how the package works with examples, let's step back\nfor a moment and assess how customizable the package should be:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},"Is there anything that might differ from user to user?"),(0,n.yg)("li",{parentName:"ul"},"Do they have to bring their API key for the package to work?"),(0,n.yg)("li",{parentName:"ul"},"Are timeouts highly subjective and specific to the local environment?")),(0,n.yg)("p",null,"For all places where it's difficult to offer a one-size-fits-all assumption, we\nwant the user to make decision on how to proceed. These customization points are\ncalled ",(0,n.yg)("em",{parentName:"p"},"inputs"),", and the correspondingly named section in the package definition\nspecifies them."),(0,n.yg)("p",null,"In our case, we hard-coded the refresh interval that updates the SSLBL lookup\ntable to exactly 1 hour. Maybe other users want to update just once a day? Or\nmore often? This is a typical example where policy is user-specific and where we\ncan turn an assumption into a decision. Let's define the input:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),"inputs:\n  refresh-interval:\n    name: Time between context updates\n    description: |\n      The duration between updates that fetch the SSLBL database via the API.\n    default: 1 hour\n")),(0,n.yg)("p",null,"By specifying a default value, we also make it easy for users to skip the\ndecision making. In other words, defaults make a configuration knob optional."),(0,n.yg)("p",null,"After we've defined our configuration knobs, we now go over the pipeline\ndefinitions and replace the hard-coded constants with a placeholder:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-yaml",metastring:'title="package.yaml"',title:'"package.yaml"'}),'pipelines:\n  update-context:\n    name: Update SSLBL Context\n    description: |\n      A pipeline that periodically refreshes the SSLBL lookup table.\n    definition: |\n      // tql2\n      every {{ inputs.refresh-interval }} {\n        load_http "from https://sslbl.abuse.ch/blacklist/sslblacklist.csv"\n        read_csv comments=true, header="timestamp,SHA1,reason"\n        legacy "context update sslbl --key=SHA1"\n      }\n    restart-on-error: 1 hour\n')),(0,n.yg)("p",null,"Note how we simply replaced ",(0,n.yg)("inlineCode",{parentName:"p"},"1h")," with ",(0,n.yg)("inlineCode",{parentName:"p"},"{{ inputs.refresh-interval }}"),"."),(0,n.yg)("h2",h({},{id:"test-your-package"}),"Test your package"),(0,n.yg)("p",null,"When you think you're done, it's time to validate that things work as you\nexpect. This means effectively trying to install, configure and use it."),(0,n.yg)("admonition",h({},{title:"Testing Framework",type:"note"}),(0,n.yg)("p",{parentName:"admonition"},"We currently don't offer a native testing framework for packages where you can\nprovide tests and baselines along the package definition. But we love the idea,\nand if you do as well, please swing by our ",(0,n.yg)("a",h({parentName:"p"},{href:"/discord"}),"Community Discord")," and\ndiscuss it with us.")),(0,n.yg)("p",null,(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/installation/install-a-package"}),"Installing a package")," given a ",(0,n.yg)("inlineCode",{parentName:"p"},"package.yaml"),"\nfile is easiest with the ",(0,n.yg)("a",h({parentName:"p"},{href:"/v4.20/operators/package"}),(0,n.yg)("inlineCode",{parentName:"a"},"package_add"))," operator, since\na package is just data:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'load_file "/path/to/package.yaml"\nread_yaml\npackage_add\n')),(0,n.yg)("p",null,"This fails with the following error:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{}),"error: failed to add package\n = note: with error: !! unspecified: named argument `header` does not exist\n = note: failed to add package\n")),(0,n.yg)("p",null,"Doh, we didn't substitute the template ",(0,n.yg)("inlineCode",{parentName:"p"},"{{ inputs.refresh-interval }}"),". We can\ndo this with one extra statement, though:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'load_file "/path/to/package.yaml"\nread_yaml\nconfig.inputs["refresh-interval"] = 1h\npackage_add\n')),(0,n.yg)("p",null,"NB: We have to access the field ",(0,n.yg)("inlineCode",{parentName:"p"},"refresh-interval")," in ",(0,n.yg)("inlineCode",{parentName:"p"},"config.inputs")," via ",(0,n.yg)("inlineCode",{parentName:"p"},"[]"),"\nbecause ",(0,n.yg)("inlineCode",{parentName:"p"},"config.inputs.refresh-interval")," would be parsed as a subtraction\nbetween two fields."),(0,n.yg)("p",null,"The package should show up in the list of packages after installation:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{}),'// tql2\npackages\nwhere id == "sslbl"\n')),(0,n.yg)("p",null,"The pipelines that came with the package also have its ID prefixed:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{}),'// tql2\npipelines\nwhere id.starts_with("sslbl")\n')),(0,n.yg)("p",null,"And the context is also there:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{}),'// tql2\ncontexts\nwhere id.starts_with("sslbl")\n')),(0,n.yg)("p",null,"Since we checked that everything works as expected, we now remove our package\nwith:"),(0,n.yg)("pre",null,(0,n.yg)("code",h({parentName:"pre"},{className:"language-tql"}),'// tql2\npackage_remove "sslbl"\n')),(0,n.yg)("h2",h({},{id:"share-and-contribute"}),"Share and contribute"),(0,n.yg)("p",null,"\ud83d\ude4c Fantastic, you've just wrapped a use case and made it accessible to a broader\naudience! Now spread the word and share it with the broader community of Tenzir\nusers for an even bigger impact. Here's how:"),(0,n.yg)("ol",null,(0,n.yg)("li",{parentName:"ol"},"Join our ",(0,n.yg)("a",h({parentName:"li"},{href:"/discord"}),"Discord server")," and showcase your package in the\nshow-and-tell channel. We encourage you to seek feedback to make your package\neven better."),(0,n.yg)("li",{parentName:"ol"},"File a ",(0,n.yg)("a",h({parentName:"li"},{href:"https://github.com/tenzir/library/pull/23"}),"pull request")," in the\nofficial ",(0,n.yg)("a",h({parentName:"li"},{href:"https://github.com/tenzir/library"}),"Community Library")," GitHub\nrepository. All packages in there will automatically show up in the ",(0,n.yg)("a",h({parentName:"li"},{href:"https://app.tenzir.com/library"}),"Tenzir\nLibrary"),"."),(0,n.yg)("li",{parentName:"ol"},"Share it on social media and let us know. We'll amplify it! \ud83e\udef6")))}v.isMDXComponent=!0}}]);